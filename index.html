<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>애니메이션 추천 시스템 (CBF)</title>
    <style>
        /* (꼬부기 테마... 생략) */
        :root {
            --squirtle-light-blue: #E0F7FA; --squirtle-blue: #7FDBFF;
            --squirtle-dark-blue: #00A3D9; --text-dark: #333;
            --border-color: #B2EBF2; --bg-white: #ffffff;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; background-color: var(--squirtle-light-blue); }
        h1, h2, h3 { color: var(--squirtle-dark-blue); }
        h1 { 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 10px; 
            font-family: 'Arial Black', 'Garamond', sans-serif; /* 폰트 스타일 추가 */
            font-size: 2.5em; /* 폰트 크기 조정 */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2); /* 텍스트 그림자 추가 */
            letter-spacing: 1px; /* 글자 간격 조정 */
        }

        /* --- [ ★★★ 수정된 부분 ★★★ ] (Naver 검색창 + 자동완성) --- */
        .search-container {
            position: relative; /* 자동완성 기준점 */
            width: 100%;
            max-width: 600px;
        }
        .search-bar-container {
            display: flex;
            align-items: center;
            height: 50px;
            border: 2px solid var(--squirtle-dark-blue);
            border-radius: 25px;
            background-color: var(--bg-white);
            padding-left: 15px;
        }
        .search-logo { font-size: 24px; font-weight: 900; color: var(--squirtle-dark-blue); margin-right: 15px; user-select: none; }
        .search-bar-container input[type="text"] {
            flex-grow: 1; border: none; outline: none;
            font-size: 1.2em; background: transparent;
        }
        .search-bar-container button {
            height: 100%; border: none; background: transparent;
            font-size: 24px; color: var(--squirtle-dark-blue);
            cursor: pointer; padding: 0 20px;
        }
        
        /* [신규] 자동완성 드롭다운 */
        #suggestions-box {
            position: absolute;
            top: 55px; /* 검색창 바로 아래 */
            left: 0;
            right: 0;
            background-color: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 12px 20px;
            font-size: 1.1em;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0faff;
        }
        /* ----------------------------------- */

        .mode-selector { margin: 15px 0; font-size: 1.1em; color: var(--text-dark); }
        .mode-selector input[type="radio"] { margin-left: 15px; }

        /* (결과 레이아웃... 생략) */
        .container { display: flex; gap: 30px; margin-top: 20px; }
        .main { flex: 2; }
        .sidebar { flex: 1; }
        #main-info { background-color: var(--bg-white); border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        #main-info img { width: 225px; height: 318px; border-radius: 8px; float: right; margin-left: 20px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        #main-info h2 { margin-top: 0; }
        .tag { display: inline-block; background-color: var(--squirtle-blue); color: var(--text-dark); padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 0.9em; }
        #rec-list ul { list-style: none; padding: 0; }
        #rec-list li { background-color: var(--bg-white); padding: 12px; margin-bottom: 8px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: background-color 0.2s; border-left: 5px solid var(--border-color); }
        #rec-list li:hover { background-color: #f0faff; border-left-color: var(--squirtle-dark-blue); }
        #rec-list li .rec-title { font-size: 1.1em; font-weight: 600; color: #333; }
        #rec-list li .rec-explain { font-size: 0.9em; color: #555; margin-top: 5px; }
        #rec-list li .rec-explain .score { font-weight: 700; color: var(--squirtle-dark-blue); }
    </style>
</head>
<body>
    <h1> 빈이의 전용 애니 추천기</h1>

    <div class="search-container">
        <div class="search-bar-container">
            <span class="search-logo">Ani</span>
            <input type="text" id="titleInput" placeholder="애니 제목을 입력해 주세요." 
                   oninput="handleAutocomplete()" autocomplete="off">
            <button onclick="handleSearch()">🔍</button>
        </div>
        <div id="suggestions-box"></div>
    </div>
    <div class="mode-selector">
        <strong>추천 방식:</strong>
        <input type="radio" id="mode_cbf" name="rec_mode" value="cbf" checked>
        <label for="mode_cbf">1. 표준 CBF (콘텐츠)</label>
        <input type="radio" id="mode_hybrid" name="rec_mode" value="hybrid">
        <label for="mode_hybrid">2. 하이브리드 (CBF+Apriori)</label>
        <input type="radio" id="mode_cf" name="rec_mode" value="cf">
        <label for="mode_cf">3. CF (유저 평점 기반)</label>
    </div>

    <hr style="border: 1px solid var(--border-color); margin-top: 20px;">
    
    <div class="container">
        <div class="main" id="main-info"><h3>애니메이션 정보</h3><p>...</p></div>
        <div class="sidebar" id="rec-list"><h3>추천 목록 (10개)</h3><ul></ul></div>
    </div>

    <script>
        // --- [신규] 자동완성 함수 ---
        let autocompleteTimer; // 디바운싱 타이머
        async function handleAutocomplete() {
            clearTimeout(autocompleteTimer);
            const query = document.getElementById('titleInput').value;
            const suggestionsBox = document.getElementById('suggestions-box');
            
            if (query.length < 1) { // 1글자 미만이면 닫기
                suggestionsBox.innerHTML = '';
                return;
            }
            
            // 0.2초 기다렸다가 API 호출 (너무 자주 호출하는 것 방지)
            autocompleteTimer = setTimeout(async () => {
                const response = await fetch(`http://127.0.0.1:5001/suggest?q=${query}`);
                const suggestions = await response.json();
                showSuggestions(suggestions);
            }, 200);
        }

        // [신규] 자동완성 목록 UI 생성
        function showSuggestions(suggestions) {
            const suggestionsBox = document.getElementById('suggestions-box');
            suggestionsBox.innerHTML = '';
            if (suggestions.length === 0) return;

            suggestions.forEach(title => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerText = title;
                // [수정] 클릭 시 selectSuggestion 함수 호출
                item.setAttribute('onclick', `selectSuggestion("${title.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}")`);
                suggestionsBox.appendChild(item);
            });
        }

        // [신규] 자동완성 항목 클릭 시
        function selectSuggestion(title) {
            document.getElementById('titleInput').value = title; // 입력창에 텍스트 채우기
            document.getElementById('suggestions-box').innerHTML = ''; // 드롭다운 닫기
            handleSearch(); // 바로 검색 실행
        }

        // --- 메인 검색 함수 ---
        async function getAnimeDetails(titleQuery) {
            if (!titleQuery) return;
            document.getElementById('suggestions-box').innerHTML = ''; // 검색 시 드롭다운 닫기
            
            const mode = document.querySelector('input[name="rec_mode"]:checked').value;
            const response = await fetch(`http://127.0.0.1:5001/recommend?title=${titleQuery}&mode=${mode}`);
            const data = await response.json();

            // (이하 결과 표시 로직... 생략)
            const mainInfoEl = document.getElementById('main-info');
            const recListEl = document.getElementById('rec-list').querySelector('ul');
            mainInfoEl.innerHTML = '';
            recListEl.innerHTML = '';
            if (data.error) {
                mainInfoEl.innerHTML = `<h3>검색 오류</h3><p>'${data.query_title}'(으)로 검색: ${data.error}</p>`;
                return;
            }
            const anime = data.main_anime;
            mainInfoEl.innerHTML = `
                <img src="${anime.picture}" alt="${anime.title} Poster">
                <h2>${anime.title} (MAL ID: ${anime.mal_id})</h2>
                <p><strong>점수:</strong> ${anime.score.toFixed(2)} | <strong>에피소드:</strong> ${anime.episodes} | <strong>타입:</strong> ${anime.type}</p>
                <div><strong>장르:</strong> ${anime.genres_list.map(g => `<span class="tag">${g}</span>`).join(' ')}</div>
                <div style="margin-top: 10px;"><strong>스튜디오:</strong> ${anime.studios_list.map(s => `<span class="tag">${s}</span>`).join(' ')}</div>
                <div style="margin-top: 10px;"><strong>주요 태그 (일부):</strong> ${anime.tags_list.slice(0, 10).map(t => `<span class="tag">${t}</span>`).join(' ')}</div>
            `;
            const recTitleEl = document.getElementById('rec-list').querySelector('h3');
            recTitleEl.innerText = `'${anime.title}' 기반 추천 (10개)`;
            data.recommendations.forEach(rec => {
                const li = document.createElement('li');
                let commonGenresText = (rec.common_genres && rec.common_genres.length > 0) ? rec.common_genres.join(', ') : "";
                let explainText = "";
                if(rec.similarity_score === "N/A") {
                    explainText = `<span class="score">${commonGenresText}</span>`;
                } else {
                    explainText = `유사도: <span class="score">${rec.similarity_score}점</span>`;
                    if(commonGenresText) { explainText += ` | 공통 장르: ${commonGenresText}`; }
                }
                li.innerHTML = `<div class="rec-title">${rec.title}</div><div class="rec-explain">${explainText}</div>`;
                li.setAttribute('onclick', `getAnimeDetails("${rec.title.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}")`);
                recListEl.appendChild(li);
            });
        }

        // 검색 버튼 클릭 시
        function handleSearch() {
            const title = document.getElementById('titleInput').value;
            getAnimeDetails(title);
        }
    </script>
</body>
</html>