<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì• ë‹ˆë©”ì´ì…˜ ì¶”ì²œ ì‹œìŠ¤í…œ (CBF)</title>
    <style>
        /* (ê¼¬ë¶€ê¸° í…Œë§ˆ... ìƒëµ) */
        :root {
            --squirtle-light-blue: #E0F7FA; --squirtle-blue: #7FDBFF;
            --squirtle-dark-blue: #00A3D9; --text-dark: #333;
            --border-color: #B2EBF2; --bg-white: #ffffff;
        }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; background-color: var(--squirtle-light-blue); }
        h1, h2, h3 { color: var(--squirtle-dark-blue); }
        h1 { 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 10px; 
            font-family: 'Arial Black', 'Garamond', sans-serif; /* í°íŠ¸ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
            font-size: 2.5em; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2); /* í…ìŠ¤íŠ¸ ê·¸ë¦¼ì ì¶”ê°€ */
            letter-spacing: 1px; /* ê¸€ì ê°„ê²© ì¡°ì • */
        }

        /* --- [ â˜…â˜…â˜… ìˆ˜ì •ëœ ë¶€ë¶„ â˜…â˜…â˜… ] (Naver ê²€ìƒ‰ì°½ + ìë™ì™„ì„±) --- */
        .search-container {
            position: relative; /* ìë™ì™„ì„± ê¸°ì¤€ì  */
            width: 100%;
            max-width: 600px;
        }
        .search-bar-container {
            display: flex;
            align-items: center;
            height: 50px;
            border: 2px solid var(--squirtle-dark-blue);
            border-radius: 25px;
            background-color: var(--bg-white);
            padding-left: 15px;
        }
        .search-logo { font-size: 24px; font-weight: 900; color: var(--squirtle-dark-blue); margin-right: 15px; user-select: none; }
        .search-bar-container input[type="text"] {
            flex-grow: 1; border: none; outline: none;
            font-size: 1.2em; background: transparent;
        }
        .search-bar-container button {
            height: 100%; border: none; background: transparent;
            font-size: 24px; color: var(--squirtle-dark-blue);
            cursor: pointer; padding: 0 20px;
        }
        
        /* [ì‹ ê·œ] ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ */
        #suggestions-box {
            position: absolute;
            top: 55px; /* ê²€ìƒ‰ì°½ ë°”ë¡œ ì•„ë˜ */
            left: 0;
            right: 0;
            background-color: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 12px 20px;
            font-size: 1.1em;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0faff;
        }
        /* ----------------------------------- */

        .mode-selector { margin: 15px 0; font-size: 1.1em; color: var(--text-dark); }
        .mode-selector input[type="radio"] { margin-left: 15px; }

        /* (ê²°ê³¼ ë ˆì´ì•„ì›ƒ... ìƒëµ) */
        .container { display: flex; gap: 30px; margin-top: 20px; }
        .main { flex: 2; }
        .sidebar { flex: 1; }
        #main-info { background-color: var(--bg-white); border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden; }
        #main-info img { width: 225px; height: 318px; border-radius: 8px; float: right; margin-left: 20px; margin-bottom: 10px; border: 1px solid var(--border-color); }
        #main-info h2 { margin-top: 0; }
        .tag { display: inline-block; background-color: var(--squirtle-blue); color: var(--text-dark); padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 0.9em; }
        #rec-list ul { list-style: none; padding: 0; }
        #rec-list li { background-color: var(--bg-white); padding: 12px; margin-bottom: 8px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: background-color 0.2s; border-left: 5px solid var(--border-color); }
        #rec-list li:hover { background-color: #f0faff; border-left-color: var(--squirtle-dark-blue); }
        #rec-list li .rec-title { font-size: 1.1em; font-weight: 600; color: #333; }
        #rec-list li .rec-explain { font-size: 0.9em; color: #555; margin-top: 5px; }
        #rec-list li .rec-explain .score { font-weight: 700; color: var(--squirtle-dark-blue); }
    </style>
</head>
<body>
    <h1> ë¹ˆì´ì˜ ì „ìš© ì• ë‹ˆ ì¶”ì²œê¸°</h1>

    <div class="search-container">
        <div class="search-bar-container">
            <span class="search-logo">Ani</span>
            <input type="text" id="titleInput" placeholder="ì• ë‹ˆ ì œëª©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”." 
                   oninput="handleAutocomplete()" autocomplete="off">
            <button onclick="handleSearch()">ğŸ”</button>
        </div>
        <div id="suggestions-box"></div>
    </div>
    <div class="mode-selector">
        <strong>ì¶”ì²œ ë°©ì‹:</strong>
        <input type="radio" id="mode_cbf" name="rec_mode" value="cbf" checked>
        <label for="mode_cbf">1. í‘œì¤€ CBF (ì½˜í…ì¸ )</label>
        <input type="radio" id="mode_hybrid" name="rec_mode" value="hybrid">
        <label for="mode_hybrid">2. í•˜ì´ë¸Œë¦¬ë“œ (CBF+Apriori)</label>
        <input type="radio" id="mode_cf" name="rec_mode" value="cf">
        <label for="mode_cf">3. CF (ìœ ì € í‰ì  ê¸°ë°˜)</label>
    </div>

    <hr style="border: 1px solid var(--border-color); margin-top: 20px;">
    
    <div class="container">
        <div class="main" id="main-info"><h3>ì• ë‹ˆë©”ì´ì…˜ ì •ë³´</h3><p>...</p></div>
        <div class="sidebar" id="rec-list"><h3>ì¶”ì²œ ëª©ë¡ (10ê°œ)</h3><ul></ul></div>
    </div>

    <script>
        // --- [ì‹ ê·œ] ìë™ì™„ì„± í•¨ìˆ˜ ---
        let autocompleteTimer; // ë””ë°”ìš´ì‹± íƒ€ì´ë¨¸
        async function handleAutocomplete() {
            clearTimeout(autocompleteTimer);
            const query = document.getElementById('titleInput').value;
            const suggestionsBox = document.getElementById('suggestions-box');
            
            if (query.length < 1) { // 1ê¸€ì ë¯¸ë§Œì´ë©´ ë‹«ê¸°
                suggestionsBox.innerHTML = '';
                return;
            }
            
            // 0.2ì´ˆ ê¸°ë‹¤ë ¸ë‹¤ê°€ API í˜¸ì¶œ (ë„ˆë¬´ ìì£¼ í˜¸ì¶œí•˜ëŠ” ê²ƒ ë°©ì§€)
            autocompleteTimer = setTimeout(async () => {
                const response = await fetch(`http://127.0.0.1:5001/suggest?q=${query}`);
                const suggestions = await response.json();
                showSuggestions(suggestions);
            }, 200);
        }

        // [ì‹ ê·œ] ìë™ì™„ì„± ëª©ë¡ UI ìƒì„±
        function showSuggestions(suggestions) {
            const suggestionsBox = document.getElementById('suggestions-box');
            suggestionsBox.innerHTML = '';
            if (suggestions.length === 0) return;

            suggestions.forEach(title => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerText = title;
                // [ìˆ˜ì •] í´ë¦­ ì‹œ selectSuggestion í•¨ìˆ˜ í˜¸ì¶œ
                item.setAttribute('onclick', `selectSuggestion("${title.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}")`);
                suggestionsBox.appendChild(item);
            });
        }

        // [ì‹ ê·œ] ìë™ì™„ì„± í•­ëª© í´ë¦­ ì‹œ
        function selectSuggestion(title) {
            document.getElementById('titleInput').value = title; // ì…ë ¥ì°½ì— í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
            document.getElementById('suggestions-box').innerHTML = ''; // ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            handleSearch(); // ë°”ë¡œ ê²€ìƒ‰ ì‹¤í–‰
        }

        // --- ë©”ì¸ ê²€ìƒ‰ í•¨ìˆ˜ ---
        async function getAnimeDetails(titleQuery) {
            if (!titleQuery) return;
            document.getElementById('suggestions-box').innerHTML = ''; // ê²€ìƒ‰ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
            
            const mode = document.querySelector('input[name="rec_mode"]:checked').value;
            const response = await fetch(`http://127.0.0.1:5001/recommend?title=${titleQuery}&mode=${mode}`);
            const data = await response.json();

            // (ì´í•˜ ê²°ê³¼ í‘œì‹œ ë¡œì§... ìƒëµ)
            const mainInfoEl = document.getElementById('main-info');
            const recListEl = document.getElementById('rec-list').querySelector('ul');
            mainInfoEl.innerHTML = '';
            recListEl.innerHTML = '';
            if (data.error) {
                mainInfoEl.innerHTML = `<h3>ê²€ìƒ‰ ì˜¤ë¥˜</h3><p>'${data.query_title}'(ìœ¼)ë¡œ ê²€ìƒ‰: ${data.error}</p>`;
                return;
            }
            const anime = data.main_anime;
            mainInfoEl.innerHTML = `
                <img src="${anime.picture}" alt="${anime.title} Poster">
                <h2>${anime.title} (MAL ID: ${anime.mal_id})</h2>
                <p><strong>ì ìˆ˜:</strong> ${anime.score.toFixed(2)} | <strong>ì—í”¼ì†Œë“œ:</strong> ${anime.episodes} | <strong>íƒ€ì…:</strong> ${anime.type}</p>
                <div><strong>ì¥ë¥´:</strong> ${anime.genres_list.map(g => `<span class="tag">${g}</span>`).join(' ')}</div>
                <div style="margin-top: 10px;"><strong>ìŠ¤íŠœë””ì˜¤:</strong> ${anime.studios_list.map(s => `<span class="tag">${s}</span>`).join(' ')}</div>
                <div style="margin-top: 10px;"><strong>ì£¼ìš” íƒœê·¸ (ì¼ë¶€):</strong> ${anime.tags_list.slice(0, 10).map(t => `<span class="tag">${t}</span>`).join(' ')}</div>
            `;
            const recTitleEl = document.getElementById('rec-list').querySelector('h3');
            recTitleEl.innerText = `'${anime.title}' ê¸°ë°˜ ì¶”ì²œ (10ê°œ)`;
            data.recommendations.forEach(rec => {
                const li = document.createElement('li');
                let commonGenresText = (rec.common_genres && rec.common_genres.length > 0) ? rec.common_genres.join(', ') : "";
                let explainText = "";
                if(rec.similarity_score === "N/A") {
                    explainText = `<span class="score">${commonGenresText}</span>`;
                } else {
                    explainText = `ìœ ì‚¬ë„: <span class="score">${rec.similarity_score}ì </span>`;
                    if(commonGenresText) { explainText += ` | ê³µí†µ ì¥ë¥´: ${commonGenresText}`; }
                }
                li.innerHTML = `<div class="rec-title">${rec.title}</div><div class="rec-explain">${explainText}</div>`;
                li.setAttribute('onclick', `getAnimeDetails("${rec.title.replace(/"/g, '&quot;').replace(/'/g, '&#39;')}")`);
                recListEl.appendChild(li);
            });
        }

        // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ
        function handleSearch() {
            const title = document.getElementById('titleInput').value;
            getAnimeDetails(title);
        }
    </script>
</body>
</html>